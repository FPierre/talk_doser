<!doctype html>
<html lang='fr'>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Talk Doser</title>
  </head>
  <body>
    <p>Mots les plus prononcés</p>
    <ol id='most-used-words'></ol>

    <p>Mots vulgaires</p>
    <ol id='swear-words'></ol>

    <p>Répartition des échanges par personnes</p>
    <canvas id='people-conversations-distribution'></canvas>

    <p>Jour avec le plus d'échanges</p>
    <span id='most-spoken-day'></span>

    <p>Répartition des échanges par jours de la semaine</p>
    <canvas id='week-conversations-distribution'></canvas>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js'></script>
    <script>
      const request = new XMLHttpRequest()

      request.onreadystatechange = function () {
        if (request.readyState !== 4 || request.status !== 200) {
          return
        }

        const response = JSON.parse(request.responseText)
        // console.log(response)

        requestCallback(response)
      }

      request.open('GET', 'http://localhost:8081')
      request.send()

      function requestCallback (response) {
        mostUsedWords(response)
        swearWords(response)
        weekConversationsDistribution(response)
        peopleConversationsDistribution(response)
        // mostSpokenDay(response)
      }

      function mostUsedWords (response) {
        const mostUsedWords = document.getElementById('most-used-words')
        let wordsList = ''

        for (const word in response.words) {
          const count = response.words[word].count
          let peopleCount = ''

          for (const person in response.words[word].people) {
            const personPercent = Math.floor((response.words[word].people[person] * 100) / count)
            peopleCount += `${person} : ${personPercent}%`
          }

          wordsList += `<li>${word} : ${count} (${peopleCount})</li>`
        }

        mostUsedWords.innerHTML = wordsList
      }

      function swearWords (response) {
        const swearWords = document.getElementById('swear-words')
        let swearwordsList = ''

        for (const word in response.swearwords) {
          const count = response.swearwords[word].count
          let peopleCount = ''

          for (const person in response.swearwords[word].people) {
            const personPercent = Math.floor((response.swearwords[word].people[person] * 100) / count)
            peopleCount += `${person} : ${personPercent}%`
          }

          swearwordsList += `<li>${word} : ${count} (${peopleCount})</li>`
        }

        swearWords.innerHTML = swearwordsList
      }

      function peopleConversationsDistribution (response) {
        const ctx = document.getElementById('people-conversations-distribution').getContext('2d')

        const a = Object.keys(response.people)
        const b = Object.values(response.people)

        const e = []

        for (const c in b) {
          e.push(b[c].pronounced_words)
        }

        new Chart(ctx, {
          type: 'doughnut',
          data: {
            datasets: [{
              data: e,
            }],
            labels: a
          },
          options: {}
        })
      }

      function weekConversationsDistribution (response) {
        const ctx = document.getElementById('week-conversations-distribution').getContext('2d')

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'],
            datasets: [{
              label: 'My First dataset',
              backgroundColor: 'rgb(255, 99, 132)',
              borderColor: 'rgb(255, 99, 132)',
              data: [
                response.days['Monday'],
                response.days['Tuesday'],
                response.days['Wednesday'],
                response.days['Thursday'],
                response.days['Friday'],
                response.days['Saturday'],
                response.days['Sunday']
              ],
            }]
          },
          options: {}
        })
      }

      function mostSpokenDay (response) {
        const mostSpokenDay = document.getElementById('most-spoken-day')
        mostSpokenDay.innerText = `${Object.keys(response.dates[0])[0]} (${Object.values(response.dates[0])[0]} échanges)`
      }
    </script>
  </body>
</html>
